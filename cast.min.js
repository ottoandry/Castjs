"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var Castjs=function(){function Castjs(receiver,joinpolicy){var _this=this;_classCallCheck(this,Castjs);var joinpolicies=["tab_and_origin_scoped","origin_scoped","page_scoped"];if(receiver&&joinpolicies.indexOf(receiver)!==-1){var tmp=joinpolicy;joinpolicy=receiver;receiver=tmp}this.events={};this.receiver=receiver||"B0FF80E4";this.joinpolicy=joinpolicy||"tab_and_origin_scoped";this.available=false;this.player=null;this.controller=null;this.session=null;this.device=null;this.source=null;this.title=null;this.description=null;this.poster=null;this.subtitles=[];this.volumeLevel=1;this.muted=false;this.paused=false;this.time=0;this.timePretty="00:00:00";this.duration=0;this.durationPretty="00:00:00";this.progress=0;this.state="disconnected";var interval=setInterval(function(){if(!window.chrome){clearInterval(interval);return _this.trigger("error","Casting is not available")}if(window.chrome.cast&&window.chrome.cast.isAvailable){clearInterval(interval);cast.framework.CastContext.getInstance().setOptions({receiverApplicationId:_this.receiver,autoJoinPolicy:_this.joinpolicy,language:_this.language,resumeSavedSession:_this.resume});_this.player=new cast.framework.RemotePlayer;_this.controller=new cast.framework.RemotePlayerController(_this.player);_this.controller.addEventListener("isConnectedChanged",_this.controller_isConnectedChanged.bind(_this));_this.controller.addEventListener("currentTimeChanged",_this.controller_currentTimeChanged.bind(_this));_this.controller.addEventListener("durationChanged",_this.controller_durationChanged.bind(_this));_this.controller.addEventListener("volumeLevelChanged",_this.controller_volumeLevelChanged.bind(_this));_this.controller.addEventListener("isMutedChanged",_this.controller_isMutedChanged.bind(_this));_this.controller.addEventListener("isPausedChanged",_this.controller_isPausedChanged.bind(_this));_this.controller.addEventListener("playerStateChanged",_this.controller_playerStateChanged.bind(_this));_this.available=true;_this.trigger("available")}},250)}_createClass(Castjs,[{key:"controller_isConnectedChanged",value:function controller_isConnectedChanged(){var _this2=this;setTimeout(function(){_this2.session=_this2.player.isConnected;if(!_this2.session){return}if(!_this2.player.isMediaLoaded){return}_this2.device=cast.framework.CastContext.getInstance().getCurrentSession().getCastDevice().friendlyName;_this2.source=_this2.player.mediaInfo.contentId;_this2.title=_this2.player.title||null;_this2.description=_this2.player.mediaInfo.metadata.subtitle||null;_this2.poster=_this2.player.imageUrl||null;_this2.subtitles=[];_this2.volumeLevel=_this2.player.volumeLevel;_this2.muted=_this2.player.isMuted;_this2.paused=_this2.player.isPaused;_this2.time=_this2.player.currentTime;_this2.timePretty=_this2.controller.getFormattedTime(_this2.player.currentTime);_this2.duration=_this2.player.duration;_this2.durationPretty=_this2.controller.getFormattedTime(_this2.player.duration);_this2.progress=_this2.controller.getSeekPosition(_this2.player.currentTime,_this2.player.duration);_this2.state=_this2.player.playerState.toLowerCase();for(var i in _this2.player.mediaInfo.tracks){if(_this2.player.mediaInfo.tracks[i].type==="TEXT"){_this2.subtitles.push({label:_this2.player.mediaInfo.tracks[i].name,source:_this2.player.mediaInfo.tracks[i].trackContentId})}}var active=cast.framework.CastContext.getInstance().getCurrentSession().getSessionObj().media[0].activeTrackIds;if(active.length&&_this2.subtitles[active[0]]){_this2.subtitles[active[0]].active=true}_this2.trigger("session")})}},{key:"controller_currentTimeChanged",value:function controller_currentTimeChanged(){this.time=this.player.currentTime;this.duration=this.player.duration;this.progress=this.controller.getSeekPosition(this.time,this.duration);this.timePretty=this.controller.getFormattedTime(this.time);this.durationPretty=this.controller.getFormattedTime(this.duration);this.trigger("timeupdate")}},{key:"controller_durationChanged",value:function controller_durationChanged(){this.duration=this.player.duration}},{key:"controller_volumeLevelChanged",value:function controller_volumeLevelChanged(){this.volumeLevel=this.player.volumeLevel;this.trigger("volumechange")}},{key:"controller_isMutedChanged",value:function controller_isMutedChanged(){this.muted=this.player.isMuted;this.trigger("muted")}},{key:"controller_isPausedChanged",value:function controller_isPausedChanged(){this.paused=this.player.isPaused;this.trigger("paused")}},{key:"controller_playerStateChanged",value:function controller_playerStateChanged(){this.state=this.player.playerState.toLowerCase();if(this.state==="idle"){this.trigger("ended")}this.trigger("statechange")}},{key:"on",value:function on(event,fn){if(!this.events[event]){this.events[event]=[]}this.events[event].push(fn)}},{key:"off",value:function off(event,fn){if(!event){return this.events={}}if(!this.events[event]){return}if(typeof fn==="undefined"){return this.events[event]=[]}for(var i in this.events[event]){if(this.events[event][i]===fn){this.events[event].splice(i,1);break}}}},{key:"trigger",value:function trigger(event){var tail=Array.prototype.slice.call(arguments,1);for(var i in this.events[event]){this.events[event][i].apply(this,tail)}for(var i in this.events["any"]){this.events["any"][i].apply(this,[event])}}},{key:"cast",value:function(_cast){function cast(_x){return _cast.apply(this,arguments)}cast.toString=function(){return _cast.toString()};return cast}(function(source){var _this3=this;var metadata=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!source){return this.trigger("error","No media source specified.")}metadata.source=source;for(var key in metadata){if(metadata.hasOwnProperty(key)){this[key]=metadata[key]}}cast.framework.CastContext.getInstance().requestSession().then(function(){if(!cast.framework.CastContext.getInstance().getCurrentSession()){return _this3.trigger("error","Could not connect with the cast device")}var mediaInfo=new chrome.cast.media.MediaInfo(_this3.source);mediaInfo.metadata=new chrome.cast.media.GenericMediaMetadata;if(_this3.subtitles.length){mediaInfo.textTrackStyle=new chrome.cast.media.TextTrackStyle;mediaInfo.textTrackStyle.backgroundColor="#00000000";mediaInfo.textTrackStyle.edgeColor="#00000016";mediaInfo.textTrackStyle.edgeType=chrome.cast.media.TextTrackEdgeType.DROP_SHADOW;mediaInfo.textTrackStyle.fontFamily=chrome.cast.media.TextTrackFontGenericFamily.CASUAL;mediaInfo.textTrackStyle.fontScale=1;mediaInfo.textTrackStyle.foregroundColor="#FFFFFF";var tracks=[];for(var i in _this3.subtitles){var track=new chrome.cast.media.Track(i,chrome.cast.media.TrackType.TEXT);track.name=_this3.subtitles[i].label;track.subtype=chrome.cast.media.TextTrackType.CAPTIONS;track.trackContentId=_this3.subtitles[i].source;track.trackContentType="text/vtt";track.trackId=parseInt(i);track.type=chrome.cast.media.TrackType.TEXT;tracks.push(track)}mediaInfo.tracks=tracks}mediaInfo.metadata.images=[new chrome.cast.Image(_this3.poster)];mediaInfo.metadata.title=_this3.title;mediaInfo.metadata.subtitle=_this3.description;var request=new chrome.cast.media.LoadRequest(mediaInfo);request.currentTime=_this3.time;request.autoplay=!_this3.paused;if(_this3.subtitles.length){for(var i in _this3.subtitles){if(_this3.subtitles[i].active){request.activeTrackIds=[parseInt(i)];break}}}cast.framework.CastContext.getInstance().getCurrentSession().loadMedia(request).then(function(){_this3.device=cast.framework.CastContext.getInstance().getCurrentSession().getCastDevice().friendlyName;_this3.trigger("session");return _this3},function(err){_this3.trigger("error",err);return _this3})},function(err){_this3.trigger("error",err);return _this3})})},{key:"seek",value:function seek(seconds,percentage){if(percentage){seconds=this.controller.getSeekTime(seconds,this.player.duration)}this.player.currentTime=seconds;this.controller.seek();return this}},{key:"volume",value:function volume(_float){this.player.volumeLevel=_float;this.controller.setVolumeLevel();return this}},{key:"play",value:function play(){if(this.paused){this.controller.playOrPause()}return this}},{key:"pause",value:function pause(){if(!this.paused){this.controller.playOrPause()}return this}},{key:"mute",value:function mute(){if(this.muted===false){this.controller.muteOrUnmute()}return this}},{key:"unmute",value:function unmute(){if(this.muted===true){this.controller.muteOrUnmute()}return this}},{key:"subtitle",value:function subtitle(index){var _this4=this;var request=new chrome.cast.media.EditTracksInfoRequest([parseInt(index)]);cast.framework.CastContext.getInstance().getCurrentSession().getSessionObj().media[0].editTracksInfo(request,function(){for(var i in _this4.subtitles){delete _this4.subtitles[i].active;if(i==index){_this4.subtitles[i].active=true}}return _this4},function(err){_this4.trigger("error",err)})}},{key:"disconnect",value:function disconnect(){cast.framework.CastContext.getInstance().endCurrentSession(true);this.controller.stop();this.session=false;this.source=null;this.title=null;this.description=null;this.poster=null;this.subtitles=[];this.volumeLevel=1;this.muted=false;this.paused=false;this.time=0;this.timePretty="00:00:00";this.duration=0;this.durationPretty="00:00:00";this.progress=0;this.state="disconnected";this.trigger("disconnect");return this}}]);return Castjs}();
